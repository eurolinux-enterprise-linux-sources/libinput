From a9975cb0356e4f89eb85b5ebd81d3c95ba703f27 Mon Sep 17 00:00:00 2001
From: Peter Hutterer <peter.hutterer@who-t.net>
Date: Tue, 14 Mar 2017 11:43:18 +1000
Subject: [PATCH libinput] test: fix tests for kernels without UI_GET_SYSNAME

Signed-off-by: Peter Hutterer <peter.hutterer@who-t.net>
---
 test/litest.h      | 14 ++++++++++++++
 test/test-tablet.c |  2 ++
 2 files changed, 16 insertions(+)

diff --git a/test/litest.h b/test/litest.h
index 8d4547a9..344e3068 100644
--- a/test/litest.h
+++ b/test/litest.h
@@ -28,6 +28,7 @@
 
 #include <stdbool.h>
 #include <check.h>
+#include <unistd.h>
 #include <libevdev/libevdev.h>
 #include <libevdev/libevdev-uinput.h>
 #include <libinput.h>
@@ -56,6 +57,19 @@
 #define ck_assert_uint_eq(X, Y) _ck_assert_uint(X, ==, Y)
 #endif
 
+
+/**
+ * Forces a pause on kernels where we don't have UI_GET_SYSNAME and rely on
+ * timestamps in the uinput device
+ */
+static inline void
+litest_duplicate_device_pause(void)
+{
+#ifndef UI_GET_SYSNAME
+	sleep(1);
+#endif
+}
+
 extern void litest_setup_tests_udev(void);
 extern void litest_setup_tests_path(void);
 extern void litest_setup_tests_pointer(void);
diff --git a/test/test-tablet.c b/test/test-tablet.c
index d61478fc..687f0191 100644
--- a/test/test-tablet.c
+++ b/test/test-tablet.c
@@ -2165,6 +2165,7 @@ START_TEST(tools_with_serials)
 		 * available or isn't used by libevdev (1.3, commit 2ff45c73).
 		 * Put a sleep(1) here and that usually fixes it.
 		 */
+		litest_duplicate_device_pause();
 
 		litest_push_event_frame(dev[i]);
 		litest_tablet_proximity_in(dev[i], 10, 10, NULL);
@@ -2212,6 +2213,7 @@ START_TEST(tools_without_serials)
 		 * available or isn't used by libevdev (1.3, commit 2ff45c73).
 		 * Put a sleep(1) here and that usually fixes it.
 		 */
+		litest_duplicate_device_pause();
 
 		litest_tablet_proximity_in(dev[i], 10, 10, NULL);
 
-- 
2.13.6

